import os
import psycopg2
from psycopg2.extras import RealDictCursor
from fastapi import FastAPI, Query, HTTPException, Depends
from fastapi.middleware.cors import CORSMiddleware

# --- FastAPI ì•± ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ---
app = FastAPI(title="Hudadak Air API", version="1.0")

# --- CORS ë¯¸ë“¤ì›¨ì–´ ì„¤ì • ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://maenglion.github.io", "http://localhost:8000"], # ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© ì£¼ì†Œ ì¶”ê°€
    allow_credentials=True,
    allow_methods=["GET"],
    allow_headers=["*"],
)

# --- Cloud SQL DB ì—°ê²° í•¨ìˆ˜ ---
def get_db_connection():
    # 1) ìœ ë‹‰ìŠ¤ ì†Œì¼“ ê²½ë¡œê°€ ì§ì ‘ ë“¤ì–´ì˜¨ ê²½ìš° ìµœìš°ì„ 
    host = os.getenv("DBHOST") or os.getenv("INSTANCE_UNIX_SOCKET")

    # 2) ì¸ìŠ¤í„´ìŠ¤ ì´ë¦„ìœ¼ë¡œë¶€í„° ì†Œì¼“ ê²½ë¡œ êµ¬ì„± (ì—¬ëŸ¬ í‚¤ ì§€ì›)
    if not host:
        inst = (
            os.getenv("CLOUD_SQL_CONNECTION_NAME")
            or os.getenv("INSTANCE_CONNECTION_NAME")
            or os.getenv("CLOUDSQL_INSTANCE")
            or os.getenv("SQL_INSTANCE")
            or os.getenv("DB_INSTANCE")
            or os.getenv("GOOGLE_CLOUD_SQL_INSTANCE")
            or os.getenv("INSTANCE")
        )
        host = f"/cloudsql/{inst}" if inst else None

    dbname = os.getenv("DBNAME")
    user   = os.getenv("DBUSER")
    pwd    = os.getenv("DBPASS")

    # ë””ë²„ê·¸ ë¡œê·¸ (ë¯¼ê°ì •ë³´ ì œì™¸)
    print("[DBCFG]", {"host": host, "dbname": dbname, "user": user, "pwd": bool(pwd)})

    if not host or not dbname or not user or not pwd:
        raise HTTPException(status_code=500, detail="Database config env is missing.")

    try:
        return psycopg2.connect(host=host, dbname=dbname, user=user, password=pwd)
    except Exception as e:
        print("ğŸ”¥ DATABASE CONNECTION FAILED:", e)
        raise HTTPException(status_code=500, detail="Database connection could not be established.")

# --- API ì—”ë“œí¬ì¸íŠ¸ ---
@app.get("/nearest")
def get_nearest_station(lat: float, lon: float, db=Depends(get_db_connection)):
    """ê°€ì¥ ê°€ê¹Œìš´ ì¸¡ì •ì†Œì˜ ëŒ€ê¸°ì§ˆ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    if db is None:
        raise HTTPException(status_code=503, detail="Database service is unavailable.")
    
    # PostGISë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ì¥ ê°€ê¹Œìš´ ì¸¡ì •ì†Œë¥¼ ì°¾ëŠ” ì¿¼ë¦¬
    query = """
    SELECT *, ST_Distance(geom, ST_SetSRID(ST_MakePoint(%s, %s), 4326)::geography) AS distance_m
    FROM air_quality_stations
    ORDER BY geom <-> ST_SetSRID(ST_MakePoint(%s, %s), 4326)::geography
    LIMIT 1;
    """
    try:
        with db.cursor(cursor_factory=RealDictCursor) as cur:
            # ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ëŠ” (lon, lat) ìˆœì„œë¡œ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.
            cur.execute(query, (lon, lat, lon, lat))
            result = cur.fetchone()
        
        if not result:
            raise HTTPException(status_code=404, detail="No station data found near the provided coordinates.")
        
        return result
    except Exception as e:
        print(f"ğŸ”¥ QUERY FAILED: {e}")
        raise HTTPException(status_code=500, detail="An error occurred while querying the database.")
    finally:
        if db:
            db.close()

@app.get("/")
def read_root():
    return {"status": "ok", "message": "Welcome to Hudadak Air API"}